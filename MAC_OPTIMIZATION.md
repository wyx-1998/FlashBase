# FlashBase Mac 优化指南

## 🍎 Apple Silicon (M1/M2/M3) 优化

### 1. 架构支持
- ✅ 原生 ARM64 支持
- ✅ Intel x64 兼容性（Rosetta 2）
- ✅ 通用二进制文件构建

### 2. 打包配置优化

#### electron-builder 配置
```json
{
  "mac": {
    "target": [
      {
        "target": "dmg",
        "arch": ["arm64", "x64"]
      }
    ],
    "hardenedRuntime": true,
    "gatekeeperAssess": false,
    "entitlements": "build-resources/entitlements.mac.plist"
  }
}
```

### 3. 权限配置 (entitlements.mac.plist)
- ✅ JIT 编译支持
- ✅ 网络访问权限
- ✅ 文件系统访问
- ✅ 自动化权限

### 4. 应用生命周期优化

#### 窗口关闭行为
- ✅ 关闭窗口时隐藏到托盘而非退出
- ✅ macOS Dock 图标智能显示/隐藏
- ✅ 正确的应用退出流程

#### 资源路径修复
- ✅ 打包后渲染进程路径自动检测
- ✅ app.asar 环境兼容
- ✅ 多重备用路径机制

### 5. 性能优化

#### 内存管理
- ✅ 窗口关闭时清理事件监听器
- ✅ 资源自动释放
- ✅ 进程间通信优化

#### 启动优化
- ✅ 延迟窗口显示机制
- ✅ 超时保护机制
- ✅ 错误恢复机制

### 6. 已解决的问题

#### 问题 1: 应用无法正常关闭
**原因**: 窗口关闭事件处理不当，应用进程残留
**解决方案**:
- 统一窗口关闭逻辑
- 正确设置 `isQuitting` 标志
- 添加资源清理机制

#### 问题 2: 打包后显示空白页面
**原因**: 渲染进程文件路径错误
**解决方案**:
- 动态检测运行环境
- 多重路径回退机制
- 详细的错误日志

#### 问题 3: macOS Dock 图标行为异常
**原因**: 缺少 Dock 图标显示/隐藏控制
**解决方案**:
- 窗口显示时显示 Dock 图标
- 窗口隐藏时隐藏 Dock 图标
- 托盘点击时恢复 Dock 图标

### 7. 构建命令

```bash
# 开发环境
npm run dev

# 构建应用
npm run build

# 打包 (自动生成 ARM64 + x64 通用版本)
npm run package

# 打包所有平台
npm run package:all
```

### 8. 测试检查清单

- [ ] 应用正常启动
- [ ] 窗口关闭后应用继续运行在托盘
- [ ] 托盘点击可以重新显示窗口
- [ ] 通过托盘菜单可以正常退出
- [ ] 渲染进程正常加载（无空白页面）
- [ ] 快捷键功能正常
- [ ] 剪贴板导入功能正常
- [ ] macOS 通知正常显示
- [ ] Dock 图标行为正确

### 9. 故障排除

#### 如果应用无法启动
1. 检查控制台日志
2. 验证权限配置
3. 确认文件路径正确

#### 如果显示空白页面
1. 检查渲染进程文件是否存在
2. 查看开发者工具控制台错误
3. 验证资源路径配置

#### 如果无法正常退出
1. 检查 `isQuitting` 标志设置
2. 验证事件监听器清理
3. 确认托盘菜单退出功能

### 10. 性能监控

```javascript
// 内存使用监控
process.memoryUsage()

// CPU 使用监控
process.cpuUsage()

// 事件循环延迟监控
process.hrtime()
```

---

## 📝 更新日志

### v1.1.0-dev
- ✅ 添加 Apple Silicon 原生支持
- ✅ 修复窗口关闭问题
- ✅ 修复打包后空白页面问题
- ✅ 优化 macOS Dock 图标行为
- ✅ 添加权限配置文件
- ✅ 改进错误处理和日志记录

---

**注意**: 这些优化专门针对 macOS 和 Apple Silicon 芯片进行了调整，确保应用在 M1/M2/M3 Mac 上的最佳性能和用户体验。