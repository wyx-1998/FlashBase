# Dia-FastGPT 桌面应用 - 启动工程化方案

## 🎯 目标

解决应用启动过程中的端口占用、进程残留等问题，实现一键启动的工程化能力。

## 🚀 解决方案

### 1. 一键启动脚本 (`start.sh`)

**功能特性：**
- ✅ **智能清理**：自动检查并清理端口占用和旧进程
- ✅ **环境检查**：验证 Node.js、npm 和项目依赖
- ✅ **自动构建**：增量构建主进程和渲染进程
- ✅ **分步启动**：先启动渲染服务器，再启动主进程
- ✅ **状态验证**：确保每个组件成功启动
- ✅ **日志管理**：输出到独立日志文件便于调试

**自动化流程：**
```bash
1. 进程清理 → 2. 端口检查 → 3. 依赖验证 → 4. 应用构建 → 5. 服务启动 → 6. 状态反馈
```

### 2. 状态监控脚本 (`status.sh`)

**监控内容：**
- 🔍 端口占用状态 (5173)
- 🔍 进程运行状态 (Electron、Vite)
- 🔍 日志文件大小和位置
- 🔍 服务器响应健康度
- 🔍 系统资源使用情况
- 🔍 最近错误信息

### 3. 优雅停止脚本 (`stop.sh`)

**停止策略：**
- 🛑 优雅关闭 (SIGTERM)
- 🛑 强制终止 (SIGKILL) 
- 🛑 端口清理
- 🛑 进程验证

## 📋 使用方法

### 基本命令

```bash
# 一键启动
./start.sh

# 检查状态
./status.sh

# 优雅停止
./stop.sh

# npm 方式
npm start
npm stop
```

### 高级用法

```bash
# 查看实时日志
tail -f /tmp/dia-fastgpt-*.log

# 重启应用
./stop.sh && ./start.sh

# 调试模式
DEBUG=* ./start.sh
```

## 🔧 技术修复

### 1. 构建路径问题

**问题**：Vite 构建输出路径与 Electron 加载路径不匹配

**解决方案**：
- 修正 Vite 配置输出目录
- 统一主进程加载路径为 `dist/renderer/index.html`
- 增加构建后复制步骤确保文件位置正确

### 2. 端口冲突处理

**问题**：重复启动导致端口 5173 被占用

**解决方案**：
- 启动前自动检查端口状态
- 优雅关闭占用进程，必要时强制终止
- 验证端口清理成功才继续启动

### 3. 进程管理优化

**问题**：Electron 和 Vite 进程残留

**解决方案**：
- 进程模式匹配 (`electron.*app.js`, `vite.*renderer`)
- 分级关闭策略 (TERM → KILL)
- 进程组清理避免孤儿进程

### 4. 依赖检查自动化

**问题**：缺少依赖导致启动失败

**解决方案**：
- 检查 Node.js/npm 环境
- 自动检测并安装缺失的 node_modules
- 验证关键文件存在性

## 📊 监控指标

### 启动成功标准
- ✅ Vite 服务器响应 (localhost:5173)
- ✅ Electron 主进程运行
- ✅ 构建文件完整生成
- ✅ 日志文件正常输出

### 健康检查项目
- 🔍 CPU/内存使用率
- 🔍 端口监听状态
- 🔍 错误日志统计
- 🔍 响应延迟时间

## 🛠️ 故障排除

### 常见问题及解决方案

| 问题 | 现象 | 解决方案 |
|-----|------|---------|
| 端口占用 | 启动失败，提示端口被占用 | 运行 `./stop.sh` 清理进程 |
| 构建失败 | TypeScript 编译错误 | 检查代码语法，重新安装依赖 |
| 进程残留 | 新启动失败，旧进程仍在运行 | 使用 `./stop.sh` 强制清理 |
| 文件缺失 | Electron 窗口空白 | 重新运行 `./start.sh` 完整构建 |

### 手动清理命令

```bash
# 强制清理所有相关进程
pkill -f "electron.*app.js"
pkill -f "vite.*renderer"
lsof -ti:5173 | xargs kill -9

# 重新安装依赖
rm -rf node_modules package-lock.json
npm install
```

## 📝 日志系统

### 日志文件位置
- **Vite 日志**: `/tmp/dia-fastgpt-vite.log`
- **Electron 日志**: `/tmp/dia-fastgpt-electron.log`

### 日志查看
```bash
# 实时查看所有日志
tail -f /tmp/dia-fastgpt-*.log

# 查看错误信息
grep -i "error\|fail" /tmp/dia-fastgpt-*.log
```

## 🎯 最佳实践

1. **始终使用脚本启动**：避免手动启动导致的环境不一致
2. **定期检查状态**：使用 `./status.sh` 监控应用健康度
3. **正确停止应用**：使用 `./stop.sh` 而不是强制终止
4. **查看日志调试**：遇到问题先查看日志文件
5. **保持依赖更新**：定期更新和清理 node_modules

## 🔄 持续改进

### 已实现功能
- ✅ 自动化启动流程
- ✅ 智能进程管理
- ✅ 实时状态监控
- ✅ 错误处理和恢复
- ✅ 日志系统集成

### 计划改进
- 🔄 集成 CI/CD 自动化
- 🔄 应用性能监控
- 🔄 自动化测试集成
- 🔄 配置热重载
- 🔄 版本管理工具集成

## 📈 效果对比

| 项目 | 修复前 | 修复后 |
|-----|-------|-------|
| 启动时间 | 手动多步骤，易出错 | 一键启动，30秒内完成 |
| 端口冲突 | 需手动查找并关闭进程 | 自动检测和清理 |
| 错误处理 | 依赖手动排查 | 自动诊断和修复建议 |
| 状态监控 | 无统一监控 | 实时状态检查 |
| 日志管理 | 分散在终端输出 | 集中日志文件管理 |

通过这套工程化方案，Dia-FastGPT 桌面应用的开发和维护效率得到显著提升，为后续功能开发提供了稳定的基础环境。 